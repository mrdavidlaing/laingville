#!/usr/bin/env bash

# Laingville Setup Secrets Script
# Pulls secrets from 1Password Laingville vault and creates ~/.config/env.secrets.local

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
VAULT_NAME="Laingville"
SECRETS_FILE="$HOME/.config/env.secrets.local"

# Default dry run
DRY_RUN=false

usage() {
    echo "Usage: $0 [--dry-run]"
    echo ""
    echo "  --dry-run    Preview what secrets would be set without making changes"
    exit 1
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "Unknown option: $1"
            usage
            ;;
    esac
done

check_dependencies() {
    if ! command -v op &> /dev/null; then
        echo -e "${RED}Error: 1Password CLI (op) not found.${NC}"
        echo "Please install it from: https://1password.com/downloads/command-line/"
        exit 1
    fi
    if ! command -v jq &> /dev/null; then
        echo -e "${RED}Error: jq not found.${NC}"
        echo "Please install jq (e.g., pacman -S jq, brew install jq)"
        exit 1
    fi
}

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"
if [[ -f "$LIB_DIR/shared.functions.bash" ]]; then
    source "$LIB_DIR/shared.functions.bash"
    source "$LIB_DIR/security.functions.bash"
else
    echo -e "${RED}Error: shared.functions.bash not found in lib directory${NC}"
    exit 1
fi

main() {
    echo -e "${BLUE}[KEY] Laingville Secrets Setup${NC}"
    echo "                   "
    
    check_dependencies
    
    local username=$(detect_username)
    local note_path="user/${username}"
    
    echo -e "${BLUE}[FETCH] Fetching secrets from 1Password note: $note_path${NC}"
    
    # Create .config directory if needed
    if [[ "$DRY_RUN" == false ]]; then
        mkdir -p "$(dirname "$SECRETS_FILE")"
    fi
    
    # Check if secure note exists
    if ! op item get "$note_path" --vault "$VAULT_NAME" --format json >/dev/null 2>&1; then
        echo -e "${RED}[ERROR] Secure note '$note_path' not found in Laingville vault${NC}"
        echo -e "${YELLOW}Please create a secure note named '$note_path' in 1Password with your secrets${NC}"
        exit 1
    fi
    
    # Get secrets and generate env file
    local secrets
    secrets=$(op item get "$note_path" --vault "$VAULT_NAME" --format json | jq -r '.fields[]? | select(.type == "CONCEALED") | "export \"\(.label)=\(.value)\""')
    
    if [[ -z "$secrets" ]]; then
        echo -e "${YELLOW}[WARN] No secrets found in $note_path${NC}"
        echo -e "${BLUE}Use 1Password to add CONCEALED fields to the note named '$note_path'${NC}"
        exit 0
    fi
    
    # Generate the secrets file
    local temp_file=$(mktemp --tmpdir laingville_secrets.XXXXXX)
    trap '[[ -f $temp_file ]] && rm -f "$temp_file"' EXIT
    {
        echo "# Laingville secrets for $username"
        echo "# Generated: $(date)"
        echo "# DO NOT EDIT MANUALLY - manage via 1Password 'user/${username}' secure note"
        echo ""
        echo "$secrets"
    } > "$temp_file"
    
    # Handle dry run vs actual implementation
    if [[ "$DRY_RUN" == true ]]; then
        echo -e "${YELLOW}[DRY] Dry run - would create file: $SECRETS_FILE\n${NC}"
        cat "$temp_file"
    else
        install -m 600 "$temp_file" "$SECRETS_FILE"
        echo -e "${GREEN}[OK] Created $SECRETS_FILE with $(echo "$secrets" | wc -l) secrets${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}[DONE] Secrets setup complete!${NC}"
    if [[ "$DRY_RUN" == false ]]; then
        echo -e "${BLUE}Run 'source ~/.config/env.secrets.local' to activate your secrets${NC}"
    fi
}

main "$@"