services:
  devcontainer:
    image: ghcr.io/mrdavidlaing/laingville/laingville-devcontainer:latest
    # Multi-arch image (amd64 + arm64) - Docker will select the right architecture
    volumes:
      # Mount the repository to /workspace (agent's working directory)
      - ..:/workspace:cached

      # SSH agent forwarding for Git push operations:
      # - macOS (Colima/Docker Desktop): uses /run/host-services/ssh-auth.sock (default)
      # - Linux: set DEVCONTAINER_SSH_SOCK=$SSH_AUTH_SOCK before opening devcontainer
      - ${DEVCONTAINER_SSH_SOCK:-/run/host-services/ssh-auth.sock}:/ssh-agent:ro

      # GitHub CLI config (aliases, preferences) - read-only
      # Token passed via environment variable (extracted from macOS keychain by ctl script)
      - ~/.config/gh:/home/vscode/.config/gh:ro

    environment:
      SSH_AUTH_SOCK: /ssh-agent

      # GitHub CLI authentication
      # Token extracted from host keychain by .devcontainer/bin/ctl script
      # Allows agents to use gh CLI and GitHub API
      # Run 'gh auth status' on host to see your current scopes
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}

      # Security boundary: Agent has maximum permissions WITHIN container
      # No restrictions on package installation, file access, or command execution
      # Blast radius limited to container only

    # Keep container running
    command: sleep infinity

    # Optional: Resource limits (uncomment to enable)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4.0'
    #       memory: 8G
    #     reservations:
    #       cpus: '2.0'
    #       memory: 4G
