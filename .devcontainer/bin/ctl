#!/usr/bin/env bash
# .devcontainer/bin/ctl - Devcontainer lifecycle management

set -euo pipefail

# Determine project name from directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
PROJECT_NAME="$(basename "$PROJECT_ROOT")"
COMPOSE_PROJECT="${PROJECT_NAME}_devcontainer"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Helper functions
info() {
    echo -e "${GREEN}‚úì${NC} $*"
}

warn() {
    echo -e "${YELLOW}‚ö†${NC} $*"
}

error() {
    echo -e "${RED}‚úó${NC} $*"
}

# Extract and display GitHub credentials
setup_github_credentials() {
    if ! command -v gh &>/dev/null; then
        warn "GitHub CLI (gh) not found - agents won't have GitHub API access"
        warn "Install: brew install gh"
        return 1
    fi

    if ! gh auth status &>/dev/null 2>&1; then
        warn "GitHub CLI not authenticated - agents won't have GitHub API access"
        warn "Authenticate: gh auth login"
        return 1
    fi

    # Get full auth status
    local auth_output
    auth_output=$(gh auth status 2>&1)

    # Extract active account (the one marked with ‚úì and Active account: true)
    local active_account
    active_account=$(echo "$auth_output" | grep -A 3 "‚úì Logged in" | grep "Active account: true" -B 2 | head -1 | sed 's/.*account \([^ ]*\).*/\1/')

    # Extract token scopes for active account
    local token_scopes
    token_scopes=$(echo "$auth_output" | grep -A 3 "Active account: true" | grep "Token scopes:" | sed "s/.*Token scopes: '\(.*\)'/\1/" | tr ',' '\n' | sed "s/^[[:space:]]*'//" | sed "s/'[[:space:]]*$//" | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')

    # Export token
    export GITHUB_TOKEN=$(gh auth token)

    # Display what's being handed to the agent
    echo ""
    echo "üîê GitHub credentials forwarded to agent:"
    info "Account: $active_account"
    info "Scopes: $token_scopes"
    echo ""
    echo "   Agent capabilities:"
    echo "   ‚Ä¢ Create PRs, issues, gists"
    echo "   ‚Ä¢ Read organization membership"
    echo "   ‚Ä¢ Pull from GitHub Package Registry"
    echo "   ‚Ä¢ Full access to private repositories"
    echo ""
    echo "   Blast radius: Container + GitHub API (via your token)"
    echo "   Run 'gh auth status' on host to verify your scopes"
    echo ""

    return 0
}

# Command handlers
cmd_up() {
    echo "Starting devcontainer services..."

    # Setup GitHub credentials
    setup_github_credentials || true

    # Start services
    cd "$PROJECT_ROOT/.devcontainer"
    docker compose -p "$COMPOSE_PROJECT" up -d

    info "Devcontainer started"
    echo ""
    echo "Next steps:"
    echo "  ‚Ä¢ $0 shell    - Open interactive shell"
    echo "  ‚Ä¢ $0 status   - Check service health"
}

cmd_down() {
    echo "Stopping devcontainer services..."

    cd "$PROJECT_ROOT/.devcontainer"
    docker compose -p "$COMPOSE_PROJECT" down

    info "Devcontainer stopped"
}

cmd_shell() {
    cd "$PROJECT_ROOT/.devcontainer"

    # Check if container is running
    if ! docker compose -p "$COMPOSE_PROJECT" ps --quiet devcontainer | grep -q .; then
        error "Devcontainer is not running"
        echo "Start it first: $0 up"
        exit 1
    fi

    docker compose -p "$COMPOSE_PROJECT" exec devcontainer bash
}

cmd_status() {
    cd "$PROJECT_ROOT/.devcontainer"

    echo "Devcontainer services:"
    echo ""

    # Get service status with health info
    docker compose -p "$COMPOSE_PROJECT" ps

    echo ""

    # Check if container is running and show workspace path
    if docker compose -p "$COMPOSE_PROJECT" ps --quiet devcontainer | grep -q .; then
        info "Devcontainer is running"
        echo "  Workspace: /workspace"
        echo "  Shell: $0 shell"
    else
        warn "Devcontainer is not running"
        echo "  Start: $0 up"
    fi
}

# Main command dispatcher
case "${1:-help}" in
    up)
        cmd_up
        ;;
    down)
        cmd_down
        ;;
    shell)
        cmd_shell
        ;;
    status)
        cmd_status
        ;;
    help|--help|-h)
        echo "Usage: $0 <command>"
        echo ""
        echo "Commands:"
        echo "  up      - Start devcontainer with credential forwarding"
        echo "  down    - Stop and remove devcontainer"
        echo "  shell   - Open interactive bash shell in running container"
        echo "  status  - Show service status and health"
        echo ""
        ;;
    *)
        error "Unknown command: $1"
        echo "Run '$0 help' for usage"
        exit 1
        ;;
esac
