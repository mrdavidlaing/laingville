#!/bin/bash
# Pre-push hook for Laingville repository
# Syncs beads, then runs linting and tests before allowing push

set -e

# Run beads pre-push hook first if bd is available
if command -v bd >/dev/null 2>&1; then
    echo "ğŸ”„ Running beads pre-push sync..."
    bd hooks run pre-push "$@"
    echo
fi

echo "ğŸš€ Running pre-push checks..."
echo

# Run tests on changed files
echo "ğŸ§ª Running tests on changed files..."
while read -r local_ref local_sha remote_ref remote_sha; do
    if ! ./scripts/run-changed-tests.sh "$remote_sha" "$local_sha"; then
        echo
        echo "âŒ Tests failed. Push aborted."
        echo "ğŸ’¡ Fix the issues above, or use 'git push --no-verify' to skip this hook."
        exit 1
    fi
done

echo
echo "âœ… All pre-push checks passed! Proceeding with push..."
