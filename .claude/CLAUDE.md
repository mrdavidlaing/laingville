# CLAUDE.md

**Note**: This project uses [bd (beads)](https://github.com/steveyegge/beads)
for issue tracking. Use `bd` commands instead of markdown TODOs.
See AGENTS.md for workflow details.

## Files

- `settings.json` - **Machine-specific** user settings (generated by setup-user, not in git)
- `settings.template.json` - Cross-platform template (committed to git)
- `settings.windows.json` - Windows-specific template with PATH overrides (committed to git)
- `README.md` - Detailed documentation about settings management
- `.gitignore` - Excludes machine-specific settings.json from git
- `commands/` - Custom slash commands (symlinked to ~/.claude/commands)
- `scripts/` - Helper scripts like the bash-direnv-wrapper

## Scripts

### claude-code-bash-direnv-wrapper.bash
A PreToolUse hook for the Bash tool that automatically allows direnv for directories with `.envrc` files before Claude Code runs commands. 

How it works:
1. Claude Code passes JSON with the working directory to the hook via stdin
2. The hook checks if the working directory (or a parent) has an `.envrc` file
3. If found, it runs `direnv allow` for that directory
4. Claude Code then executes the bash command with direnv automatically loading the environment

This ensures that:
- Projects with `.envrc` files have their environments properly loaded
- Nix flakes work via direnv's `use flake` directive  
- Environment variables and shell functions are available as expected
- No manual `direnv allow` is needed when Claude Code enters a new project

To debug the wrapper, set `export CLAUDE_CODE_DIRENV_DEBUG=1` in your shell before starting Claude Code.

## Wrappers

### git
A wrapper for the git command that ensures direnv environments are loaded for git operations. This is particularly important for git commits with pre-commit hooks that need tools from the nix environment (like terraform, tflint, etc.).

How it works:
1. Intercepts git commands via PATH override in Claude settings
2. Checks if current directory has an `.envrc` file
3. If found, runs: `direnv exec <dir> /usr/bin/git <args>`
4. If not found, passes through to regular git

This solves the problem where git pre-commit hooks fail because they can't find tools installed via nix/direnv.

## Machine-Specific vs Shared Configuration

**What's committed to git:**
- `settings.template.json` - Cross-platform base template
- `settings.windows.json` - Windows-specific template (if bash not in PATH)
- Commands, scripts, wrappers

**What's machine-specific (not in git):**
- `settings.json` - Generated by `setup-user` script
- Contains platform-specific paths and configurations

**How it works:**
1. Run `./bin/setup-user` to generate `settings.json` from template
2. Script detects platform (Windows/Mac/Linux)
3. On Windows: checks if bash is in PATH, uses appropriate template
4. Template variables like `{{USERNAME}}` are substituted
5. Generated file is symlinked to `~/.claude/settings.json`

## Hook Commands

All hooks use `bash` prefix for cross-platform compatibility:
- `bash ~/.local/bin/claude-code-bash-direnv-wrapper`
- `bash .claude/format-hook.sh`

This works when bash is in PATH (default on Mac/Linux, via Scoop/Git for Windows on Windows).

## Notes

- The `feedbackSurveyState` field in ~/.claude/settings.json is auto-generated internal state (not in schema)
- Settings are merged hierarchically: user settings < shared project < local project
- See `README.md` for detailed setup instructions
