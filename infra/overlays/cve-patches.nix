# infra/overlays/cve-patches.nix
# CVE patches for Critical/High vulnerabilities
# Remove patches once upstream catches up
final: prev: {
  # Pyright with patched esbuild 0.27.1 (Go 1.25.4) to fix Go stdlib CVEs:
  # - CVE-2025-61729 (HIGH): HostnameError.Error() resource exhaustion
  # - CVE-2025-58187 (HIGH): x509 name constraint checking DoS
  # - CVE-2025-58186 (HIGH): HTTP cookie parsing memory exhaustion
  # - CVE-2025-58183 (HIGH): archive/tar sparse map allocation
  # - Plus ~20 additional medium severity Go stdlib CVEs
  #
  # The upstream pyright 1.1.407 bundles esbuild via esbuild-loader which
  # resolves to 0.25.x (Go 1.23.12, vulnerable). We use npm overrides to force
  # esbuild 0.27.1 (built with Go 1.25.4) everywhere, allowing us to keep
  # esbuild-loader while ensuring the runtime closure uses the patched esbuild.
  #
  # Remove once nixpkgs updates pyright with esbuild >= 0.27.0.
  # Track: https://github.com/evanw/esbuild/releases
  pyright = final.callPackage ./pyright-patched/package.nix { };

  # Node.js 22 with patched npm 11.8.0 to fix:
  # - glob CVE-2025-64756 (HIGH): Command injection via glob CLI's -c/--cmd option
  # - tar CVE-2026-23745 (HIGH): Arbitrary file overwrite and code execution
  # - tar CVE-2026-23950 (HIGH): Arbitrary file overwrite via symlink handling
  #
  # The upstream nodejs_22 bundles npm 10.9.4 with glob 10.4.5 and tar <7.5.3 (vulnerable).
  # npm 11.8.0 includes glob 13.0.0 (fixed) and tar 7.5.4 (fixed).
  #
  # This creates nodejs_22_patched for container use. We don't override nodejs_22
  # directly because nodePackages depends on nodejs_22's complex passthru attrs.
  #
  # Remove once nixpkgs updates nodejs_22 with npm containing glob >= 10.5.0 and tar >= 7.5.4.
  # Track: https://github.com/npm/cli/releases
  nodejs_22_patched = final.callPackage ./nodejs-patched/package.nix {
    nodejs_22 = prev.nodejs_22;
  };

  # Override nodePackages to use nodejs_22_patched instead of nodejs_22.
  # This rebuilds all nodePackages.* (typescript, eslint, prettier, etc.)
  # with the patched npm 11.8.0, ensuring they use:
  # - glob 13.0.0 (fixed, was 10.4.5 vulnerable to CVE-2025-64756)
  # - tar 7.5.4 (fixed, was <7.5.3 vulnerable to CVE-2026-23745/23950)
  #
  # Remove once nixpkgs updates nodejs_22 with npm containing glob >= 10.5.0 and tar >= 7.5.4.
  nodePackages = prev.nodePackages.override {
    nodejs = final.nodejs_22_patched;
  };

   # Busybox 1.37.0 CVEs REMOVED - now in upstream nixpkgs
   # Fixed in upstream:
   # - CVE-2022-28391: sockaddr2str/nslookup printable character sanitization
   # - CVE-2022-48174 (CRITICAL): shell segfault on malformed input
   # - CVE-2023-42363, CVE-2023-42364, CVE-2023-42365, CVE-2023-42366: awk fixes
   # - tar TOCTOU symlink race condition
   #
   # nixpkgs-unstable now includes busybox >= 1.37.0 (verified 2026-01-25)
   # Overlay removed: infra/overlays/busybox-patched/ can be deleted in future cleanup
 }
