# infra/overlays/cve-patches.nix
# CVE patches for Critical/High vulnerabilities
# Remove patches once upstream catches up
final: prev: {
  # Pyright with patched esbuild 0.25.12 (Go 1.23.7+) to fix Go stdlib CVEs:
  # - CVE-2025-22871 (critical): net/http request smuggling
  # - CVE-2024-24790 (critical): net/netip ParseAddr panic
  # - CVE-2023-24531 (critical): cmd/go module checksum verification
  # - Plus ~130 additional high/medium severity Go stdlib CVEs
  #
  # The upstream pyright 1.1.407 bundles esbuild 0.19.12 (Go 1.20.12) which
  # contains these vulnerabilities. This overlay upgrades esbuild-loader to
  # 4.4.0 which pulls in esbuild 0.25.12 built with Go 1.23.7.
  #
  # Remove once nixpkgs updates pyright to a version with fixed esbuild.
  # Track: https://github.com/microsoft/pyright - watch for esbuild-loader 4.x
  pyright = final.callPackage ./pyright-patched/package.nix { };

  # Node.js 22 with patched npm 11.6.4 to fix glob CVE-2025-64756 (high):
  # - Command injection via glob CLI's -c/--cmd option with malicious filenames
  #
  # The upstream nodejs_22 bundles npm 10.9.4 with glob 10.4.5 (vulnerable).
  # npm 11.6.4 includes glob 13.0.0 (fixed).
  #
  # This creates nodejs_22_patched for container use. We don't override nodejs_22
  # directly because nodePackages depends on nodejs_22's complex passthru attrs.
  #
  # Remove once nixpkgs updates nodejs_22 with npm containing glob >= 10.5.0.
  # Track: https://github.com/npm/cli/releases
  nodejs_22_patched = final.callPackage ./nodejs-patched/package.nix {
    nodejs_22 = prev.nodejs_22;
  };
}
