#!/bin/bash

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect current user
CURRENT_USER=$(whoami)

# Map usernames to dotfiles folders
case "$CURRENT_USER" in
    "timmy")
        DOTFILES_DIR="$SCRIPT_DIR/dotfiles/timmmmmmer"
        ;;
    "david")
        DOTFILES_DIR="$SCRIPT_DIR/dotfiles/mrdavidlaing"
        ;;
    *)
        DOTFILES_DIR="$SCRIPT_DIR/dotfiles/shared"
        echo "Unknown user '$CURRENT_USER', using shared dotfiles"
        ;;
esac

echo "Setting up dotfiles for user: $CURRENT_USER"
echo "Using dotfiles from: $DOTFILES_DIR"

# Check if dotfiles directory exists
if [ ! -d "$DOTFILES_DIR" ]; then
    echo "Error: Dotfiles directory $DOTFILES_DIR does not exist"
    exit 1
fi

# Create symbolic links for all files in the dotfiles directory
if [ "$(ls -A "$DOTFILES_DIR" 2>/dev/null)" ]; then
    # Enable dotglob to include hidden files in glob patterns
    shopt -s dotglob
    for file in "$DOTFILES_DIR"/*; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            target="$HOME/$filename"
            
            # Remove existing file/symlink if it exists
            [ -e "$target" ] && rm -f "$target"
            
            # Create symbolic link
            ln -s "$file" "$target"
            echo "Linked: $filename"
        fi
    done
    shopt -u dotglob
    echo "Dotfiles setup complete!"
else
    echo "No dotfiles found in $DOTFILES_DIR"
fi