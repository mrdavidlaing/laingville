#!/bin/bash

set -e

# Source functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/setup-user.functions.bash"

# Simple argument parsing
DRY_RUN=false
if [ "$1" = "--dry-run" ]; then
    DRY_RUN=true
elif [ -n "$1" ]; then
    echo "Unknown option: $1"
    echo "Usage: $0 [--dry-run]"
    exit 1
fi

# Detect current user
CURRENT_USER=$(whoami)

# Map usernames to dotfiles folders (unless DOTFILES_DIR already set)
if [ -z "$DOTFILES_DIR" ]; then
    case "$CURRENT_USER" in
        "timmy")
            DOTFILES_DIR="$SCRIPT_DIR/dotfiles/timmmmmmer"
            ;;
        "mrdavidlaing")
            DOTFILES_DIR="$SCRIPT_DIR/dotfiles/mrdavidlaing"
            ;;
        *)
            DOTFILES_DIR="$SCRIPT_DIR/dotfiles/shared"
            echo "Unknown user '$CURRENT_USER', using shared dotfiles"
            ;;
    esac
fi

if [ "$DRY_RUN" = true ]; then
    echo "DRY RUN MODE - No changes will be made"
    echo ""
fi

echo "Setting up dotfiles for user: $CURRENT_USER"
echo "Using dotfiles from: $DOTFILES_DIR"

# Check if dotfiles directory exists
if [ ! -d "$DOTFILES_DIR" ]; then
    echo "Error: Dotfiles directory $DOTFILES_DIR does not exist"
    exit 1
fi

# Handle dotfiles
if [ "$(ls -A "$DOTFILES_DIR" 2>/dev/null)" ]; then
    if [ "$DRY_RUN" = true ]; then
        echo "SYMLINKS:"
        show_symlinks "$DOTFILES_DIR" "$HOME" ""
    else
        create_symlinks "$DOTFILES_DIR" "$HOME" ""
        
        # Reload Hyprland config if hyprland.conf was linked and Hyprland is running
        if [ -f "$HOME/.config/hypr/hyprland.conf" ] && command -v hyprctl >/dev/null 2>&1; then
            if hyprctl version >/dev/null 2>&1; then
                echo "Reloading Hyprland configuration..."
                hyprctl reload >/dev/null 2>&1 || echo "Warning: Could not reload Hyprland config"
            fi
        fi
        echo "Dotfiles setup complete!"
    fi
else
    if [ "$DRY_RUN" = true ]; then
        echo "SYMLINKS:"
        echo "No dotfiles found - no symlinks would be created"
    else
        echo "No dotfiles found in $DOTFILES_DIR"
    fi
fi

# Handle package management
PLATFORM=$(detect_platform)
echo ""
handle_packages "$PLATFORM" "$DRY_RUN"

# Setup systemd user services (like dynamic wallpaper timer)
echo ""
setup_systemd_services "$DRY_RUN"

[ "$DRY_RUN" = false ] && echo "Setup complete!"

# Explicit exit for proper status
exit 0