#!/usr/bin/env bash
# omo-profile - Switch oh-my-opencode category-to-model mappings
#
# Merges category model assignments from profile files into oh-my-opencode.json,
# preserving agent definitions and other configuration sections.
#
# Usage:
#   omo-profile [profile]    Switch to profile
#   omo-profile              Show current profile
#   omo-profile --list       List available profiles
#   omo-profile --help       Show this help
#
# Profiles:
#   Mo (work - direct provider access):
#     mo-speed       - Fast models (Haiku, Sonnet, Gemini Flash, o3-mini)
#     mo-best        - Best models (Sonnet, Opus, Gemini Pro, o1)
#
#   Personal (opencode provider - Zen Models):
#     personal-free  - Free models (GPT-5 Nano, Big Pickle)
#     personal-value - Value models (GPT-5.1 Mini, Qwen3 Coder, Kimi K2 Thinking)
#     personal-best  - Best models (Haiku 4.5, Sonnet 4.5, Opus 4.5)

set -e

OPENCODE_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/opencode"
OPENCODE_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/opencode"
PROFILES_DIR="$OPENCODE_CONFIG_DIR/omo-profiles"
TARGET_FILE="$OPENCODE_CONFIG_DIR/oh-my-opencode.json"
OPENCODE_CORE_FILE="$OPENCODE_CONFIG_DIR/opencode.json"
OMO_BIN="$OPENCODE_CACHE_DIR/node_modules/.bin/oh-my-opencode"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
  cat << 'EOF'
omo-profile - Switch oh-my-opencode category-to-model mappings

Merges category model assignments from profile files into oh-my-opencode.json,
preserving agent definitions (Atlas, Prometheus, etc.) and other configuration.

Usage:
  omo-profile [profile]    Switch to profile
  omo-profile              Show current profile
  omo-profile --list       List available profiles
  omo-profile --help       Show this help

Profiles:

  Mo (work - direct provider access):
    mo-speed       Fast models (Haiku, Sonnet, Gemini Flash, o3-mini)
    mo-best        Best models (Sonnet, Opus, Gemini Pro, o1)

  Personal (opencode provider - Zen Models):
    personal-free  Free models (GPT-5 Nano, Big Pickle)
    personal-value Value models (GPT-5.1 Mini, Qwen3 Coder, Kimi K2 Thinking)
    personal-best  Best models (Haiku 4.5, Sonnet 4.5, Opus 4.5)

Examples:
  omo-profile mo-speed         # Switch to mo-speed profile
  omo-profile personal-value   # Switch to personal-value profile
  omo-profile                  # Show current profile
  omo-profile --list           # List all available profiles
EOF
}

list_profiles() {
  echo -e "${BLUE}Available profiles:${NC}"
  echo ""
  local current_profile
  current_profile=$(get_current_profile)
  for profile_file in "$PROFILES_DIR"/*.json; do
    if [[ -f "$profile_file" ]]; then
      profile_name=$(basename "$profile_file" .json)
      if [[ "$profile_name" == "$current_profile" ]]; then
        echo -e "  ${GREEN}* $profile_name${NC} (active)"
      else
        echo "    $profile_name"
      fi
    fi
  done
  echo ""
}

get_current_profile() {
  if [[ ! -f "$TARGET_FILE" ]]; then
    echo "(none)"
    return
  fi

  # Compare current config against each profile by checking .categories section
  local current_categories
  current_categories=$(jq -cS '.categories // {}' "$TARGET_FILE" 2>/dev/null) || {
    echo "(invalid json)"
    return
  }

  for profile_file in "$PROFILES_DIR"/*.json; do
    if [[ -f "$profile_file" ]]; then
      local profile_categories
      profile_categories=$(jq -cS '.categories // {}' "$profile_file" 2>/dev/null) || continue
      if [[ "$current_categories" == "$profile_categories" ]]; then
        basename "$profile_file" .json
        return
      fi
    fi
  done

  echo "(custom config)"
}

show_status() {
  if [[ -x "$OMO_BIN" ]]; then
    "$OMO_BIN" doctor --verbose
  else
    echo -e "${YELLOW}Warning: oh-my-opencode binary not found at $OMO_BIN${NC}"
  fi
}

switch_profile() {
  local profile="$1"
  local profile_file="$PROFILES_DIR/$profile.json"
  local backup_file="$TARGET_FILE.backup"

  if [[ ! -f "$profile_file" ]]; then
    echo -e "${RED}Error: Profile '$profile' not found${NC}" >&2
    echo "Available profiles:" >&2
    ls -1 "$PROFILES_DIR"/*.json 2>/dev/null | xargs -I {} basename {} .json | sed 's/^/  /' >&2
    exit 1
  fi

  # Ensure config directory exists
  mkdir -p "$OPENCODE_CONFIG_DIR"

  # Backup existing config before merging
  if [[ -f "$TARGET_FILE" ]]; then
    cp "$TARGET_FILE" "$backup_file"

    # Merge profiles
    # We use a merge that replaces categories and agents with the ones from the profile
    jq -s '.[0] * .[1]' "$TARGET_FILE" "$profile_file" > "$TARGET_FILE.tmp"
    mv "$TARGET_FILE.tmp" "$TARGET_FILE"

    # Also update core opencode.json with the profile default model if present
    local profile_model
    profile_model=$(jq -r '.model // empty' "$profile_file")
    if [[ -n "$profile_model" ]] && [[ -f "$OPENCODE_CORE_FILE" ]]; then
      jq --arg model "$profile_model" '.model = $model' "$OPENCODE_CORE_FILE" > "$OPENCODE_CORE_FILE.tmp"
      mv "$OPENCODE_CORE_FILE.tmp" "$OPENCODE_CORE_FILE"
    fi
  else
    # First time - just copy
    cp "$profile_file" "$TARGET_FILE"
    
    # Update core model if base config exists
    local profile_model
    profile_model=$(jq -r '.model // empty' "$profile_file")
    if [[ -n "$profile_model" ]] && [[ -f "$OPENCODE_CORE_FILE" ]]; then
      jq --arg model "$profile_model" '.model = $model' "$OPENCODE_CORE_FILE" > "$OPENCODE_CORE_FILE.tmp"
      mv "$OPENCODE_CORE_FILE.tmp" "$OPENCODE_CORE_FILE"
    fi
  fi

  echo -e "${GREEN}Switched to '$profile' profile${NC}"
  echo ""
  show_status
}

# Main
case "${1:-}" in
  --help|-h)
    show_help
    ;;
  --list|-l)
    list_profiles
    ;;
  "")
    current=$(get_current_profile)
    echo -e "Current profile: ${GREEN}$current${NC}"
    echo ""
    show_status
    echo ""
    echo "Use 'omo-profile --list' to see available profiles"
    echo "Use 'omo-profile <name>' to switch profiles"
    ;;
  *)
    switch_profile "$1"
    ;;
esac
