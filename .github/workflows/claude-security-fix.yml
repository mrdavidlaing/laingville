# .github/workflows/claude-security-fix.yml
name: Claude Security Fix

on:
  # Run weekly on Mondays at 9am UTC
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:
  # Optionally trigger after security scans find issues
  workflow_run:
    workflows: ["Security Scan"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: read
  security-events: read

jobs:
  claude-security-fix:
    name: Run Claude /security-fix Command
    runs-on: ubuntu-latest
    # Only run if we have the API key configured
    if: vars.ANTHROPIC_API_KEY != '' || secrets.ANTHROPIC_API_KEY != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Claude CLI
        run: |
          npm install -g @anthropic/claude-cli
          claude --version

      - name: Configure git
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          # Generate unique branch name with timestamp
          BRANCH="claude/security-fix-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH"

      - name: Run Claude /security-fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Run Claude with the /security-fix slash command
          # Using stream-json for better visibility in logs
          claude -p "/security-fix" \
            --output-format stream-json \
            --max-turns 20 \
            --model claude-sonnet-4-5-20250929 \
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Claude"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Stage all changes
          git add -A

          # Check if there are staged changes
          if git diff --cached --quiet; then
            echo "No staged changes to commit"
            exit 0
          fi

          # Create commit with detailed message
          git commit -m "chore: security fixes via Claude /security-fix" \
                     -m "Automated security remediation by Claude Code CLI" \
                     -m "- Analyzed GitHub security alerts" \
                     -m "- Applied fixes per /security-fix playbook" \
                     -m "- Review changes and test before merging" \
                     -m "" \
                     -m "Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push -u origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸ”’ Security: Automated fixes from Claude /security-fix" \
            --body "$(cat <<'EOF'
          ## Automated Security Remediation

          This PR was automatically generated by the Claude CLI running the `/security-fix` command.

          ### What was done
          - Analyzed open GitHub security code-scanning alerts
          - Identified highest-impact vulnerabilities (CRITICAL/HIGH severity + broad blast radius)
          - Applied fixes following the security-fix playbook:
            1. First attempted upstream nixpkgs update
            2. If needed, added targeted Nix overlays/patches

          ### Review Checklist
          - [ ] Review all file changes for correctness
          - [ ] Verify security issues are actually fixed
          - [ ] Check that no unintended changes were made
          - [ ] Ensure tests pass in CI
          - [ ] Confirm security scans show improvement

          ### Next Steps
          1. Review the changes carefully
          2. Run local tests if needed
          3. Merge if changes look good
          4. Security scans will automatically run on main after merge
          5. Verify alerts are closed in GitHub Security tab

          ### Related Workflows
          - Security Scan workflow will validate these fixes
          - Build Containers workflow will publish updated images

          ---

          ðŸ¤– Generated by [Claude Code](https://claude.ai/code) via GitHub Actions
          ðŸ“‹ Slash command: `/security-fix`
          â° Triggered: ${{ github.event_name }}
          EOF
          )" \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }} \
            --label "security,automated"

      - name: Summary
        if: always()
        run: |
          echo "## Claude Security Fix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Security fixes applied**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Branch: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Pull Request created with proposed fixes" >> $GITHUB_STEP_SUMMARY
            echo "- Review the PR and merge if changes look good" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes needed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Claude analyzed the repository and found:" >> $GITHUB_STEP_SUMMARY
            echo "- No actionable security issues, or" >> $GITHUB_STEP_SUMMARY
            echo "- All existing patches are sufficient, or" >> $GITHUB_STEP_SUMMARY
            echo "- Issues require manual intervention" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the job logs above for Claude's detailed analysis." >> $GITHUB_STEP_SUMMARY
