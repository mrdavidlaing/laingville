# .github/workflows/claude-security-fix.yml
name: Claude Security Fix

on:
  # Run weekly on Mondays at 9am UTC
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      model:
        description: 'Claude model to use'
        required: false
        default: 'claude-sonnet-4-5-20250929'
        type: choice
        options:
          - claude-sonnet-4-5-20250929
          - claude-opus-4-5-20251101
  # Trigger after security scans find issues (only on success)
  workflow_run:
    workflows: ["Security Scan"]
    types: [completed]
    branches: [main]

# Prevent multiple concurrent runs to avoid duplicate PRs and API waste
concurrency:
  group: claude-security-fix
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: read
  security-events: read
  id-token: write

jobs:
  claude-security-fix:
    name: Run Claude /security-fix Command
    runs-on: ubuntu-latest
    # Only run if workflow_run succeeded (or not from workflow_run)
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "::error::CLAUDE_CODE_OAUTH_TOKEN secret is not configured"
            echo "Please add your Claude Code OAuth token to repository secrets"
            echo "See: .github/workflows/README.md for setup instructions"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone is sufficient
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Configure git
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          # Generate unique branch name with high-precision timestamp and random suffix
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RANDOM_SUFFIX=$(openssl rand -hex 3)
          BRANCH="claude/security-fix-${TIMESTAMP}-${RANDOM_SUFFIX}"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH"

      - name: Run Claude /security-fix
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Run the /security-fix command to analyze and fix security issues.
            
            Follow the playbook in .claude/commands/security-fix.md.
            You have access to 'nix' and standard bash tools.
            Do not commit changes; the workflow handles committing.
          claude_args: '--model ${{ inputs.model || 'claude-sonnet-4-5-20250929' }} --allowed-tools "Bash,Read,Edit,Write,Glob,Grep"'

      - name: Check for changes
        id: changes
        run: |
          # Check for any changes in tracked or untracked files
          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Claude"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          fi

      - name: Validate and stage changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Only stage files in expected directories for security fixes
          # This prevents accidentally committing unintended files
          git add --all \
            infra/ \
            .github/workflows/ \
            .beads/ \
            .claude/commands/ || true

          # Show what will be committed
          echo "Files to be committed:"
          git diff --cached --name-status

          # Double-check we have changes to commit
          if git diff --cached --quiet; then
            echo "::warning::Changes detected but not in expected directories"
            echo "::warning::Only infra/, .github/workflows/, .beads/, .claude/commands/ are committed"
            echo "Untracked/unexpected files:"
            git status --short
            exit 1
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Create commit with detailed message
          git commit -m "chore: security fixes via Claude /security-fix" \
                     -m "Automated security remediation by Claude Code CLI" \
                     -m "" \
                     -m "Changes applied:" \
                     -m "- Analyzed GitHub security code-scanning alerts" \
                     -m "- Applied fixes per /security-fix playbook" \
                     -m "- Review changes and test before merging" \
                     -m "" \
                     -m "Claude Code Action completed successfully" \
                     -m "" \
                     -m "Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push -u origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸ”’ Security: Automated fixes from Claude /security-fix" \
            --body "$(cat <<'EOF'
          ## Automated Security Remediation

          This PR was automatically generated by the Claude Code Action running the `/security-fix` command.

          **Model used:** ${{ inputs.model || 'claude-sonnet-4-5-20250929' }}
          **Triggered by:** ${{ github.event_name }}

          ### What was done
          - Analyzed open GitHub security code-scanning alerts
          - Identified highest-impact vulnerabilities (CRITICAL/HIGH severity + broad blast radius)
          - Applied fixes following the security-fix playbook:
            1. First attempted upstream nixpkgs update
            2. If needed, added targeted Nix overlays/patches

          ### Review Checklist
          - [ ] Review all file changes for correctness
          - [ ] Verify security issues are actually fixed
          - [ ] Check that no unintended changes were made
          - [ ] Ensure tests pass in CI
          - [ ] Confirm security scans show improvement
          - [ ] Check Claude Action logs for any warnings/errors

          ### Next Steps
          1. Review the changes carefully
          2. Run local tests if needed
          3. Merge if changes look good
          4. Security scans will automatically run on main after merge
          5. Verify alerts are closed in GitHub Security tab

          ### Related Workflows
          - Security Scan workflow will validate these fixes
          - Build Containers workflow will publish updated images

          ---

          ðŸ¤– Generated by [Claude Code](https://claude.ai/code) via GitHub Actions
          ðŸ“‹ Slash command: `/security-fix`
          â° Triggered: ${{ github.event_name }}

          **Cost estimate:** ~$0.15-0.50 per run (depends on complexity)
          EOF
          )" \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }} \
            --label "security,automated"

      - name: Summary
        if: always()
        run: |
          echo "## Claude Security Fix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Claude Action completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Claude Action failed or was cancelled" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Changes status
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "### âœ… Security fixes applied" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Model:** \`${{ inputs.model || 'claude-sonnet-4-5-20250929' }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Pull Request created with proposed fixes" >> $GITHUB_STEP_SUMMARY
            echo "- Review the PR and merge if changes look good" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Claude analyzed the repository and found:" >> $GITHUB_STEP_SUMMARY
            echo "- No actionable security issues, or" >> $GITHUB_STEP_SUMMARY
            echo "- All existing patches are sufficient, or" >> $GITHUB_STEP_SUMMARY
            echo "- Issues require manual intervention" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Details" >> $GITHUB_STEP_SUMMARY
          echo "- Check the [job logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for full details" >> $GITHUB_STEP_SUMMARY
          echo "- Estimated API cost: \$0.15-0.50 per run" >> $GITHUB_STEP_SUMMARY
