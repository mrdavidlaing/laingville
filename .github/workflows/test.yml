name: Test Laingville Scripts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-bash:
    name: Bash Tests
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: ubuntu
            runner: ubuntu-latest
          - os: macos-latest
            platform: macos
            runner: macos-latest
          - os: archlinux
            platform: archlinux
            runner: ubuntu-latest
            container: archlinux:latest
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache tools (Ubuntu)
      if: matrix.platform == 'ubuntu'
      id: cache-tools-ubuntu
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/shellspec
          ~/.local/bin/shellcheck
          ~/.local/bin/shfmt
          ~/.local/bin/kcov
          ~/.local/lib/shellspec
        key: tools-ubuntu-shfmt-3.8.0-shellcheck-0.10.0-shellspec-v2-kcov-pkg

    - name: Cache tools (Arch Linux)
      if: matrix.platform == 'archlinux'
      id: cache-tools-arch
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/shellspec
          ~/.local/bin/shellcheck
          ~/.local/bin/shfmt
          ~/.local/bin/kcov
          ~/.local/lib/shellspec
        key: tools-archlinux-shfmt-3.8.0-shellcheck-0.10.0-shellspec-v2-kcov-pkg-bc

    - name: Cache tools (macOS)
      if: matrix.platform == 'macos'
      id: cache-tools-macos
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/shellspec
          ~/.local/bin/shellcheck
          ~/.local/bin/shfmt
          ~/.local/lib/shellspec
        key: tools-macos-shfmt-3.8.0-shellcheck-0.10.0-shellspec-v2

    - name: Install tools (Ubuntu)
      if: matrix.platform == 'ubuntu' && steps.cache-tools-ubuntu.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/.local/bin
        
        # Install shellcheck
        cd /tmp
        wget -qO- https://github.com/koalaman/shellcheck/releases/download/v0.10.0/shellcheck-v0.10.0.linux.x86_64.tar.xz | tar -xJ
        mv shellcheck-v0.10.0/shellcheck ~/.local/bin/
        chmod +x ~/.local/bin/shellcheck
        
        # Install shfmt
        wget -qO ~/.local/bin/shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64
        chmod +x ~/.local/bin/shfmt
        
        # Install shellspec
        curl -fsSL https://git.io/shellspec | sh -s -- --yes
        
        # Install kcov for coverage (try package first, build from source if unavailable)
        sudo apt-get update
        if sudo apt-get install -y kcov; then
          echo "Using kcov from apt package"
          cp /usr/bin/kcov ~/.local/bin/
        else
          echo "kcov package not available, building from source..."
          sudo apt-get install -y cmake ninja-build libcurl4-openssl-dev libelf-dev libdw-dev binutils-dev libiberty-dev
          cd /tmp
          git clone --depth 1 https://github.com/SimonKagstrom/kcov.git
          cd kcov
          mkdir build && cd build
          cmake -G 'Ninja' ..
          ninja
          sudo ninja install
          cp /usr/local/bin/kcov ~/.local/bin/
        fi

    - name: Install tools (Arch Linux)
      if: matrix.platform == 'archlinux' && steps.cache-tools-arch.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/.local/bin
        
        # Update package database and install base tools (skip system upgrade for speed)
        pacman -Sy --noconfirm
        pacman -S --noconfirm base-devel git cmake ninja curl wget tar gzip tmux bc
        
        # Install dependencies for kcov
        pacman -S --noconfirm libcurl-gnutls elfutils binutils
        
        # Install kcov for coverage (try package manager first)
        pacman -S --noconfirm kcov || {
          echo "Package kcov not available, building from source..."
          cd /tmp
          git clone https://github.com/SimonKagstrom/kcov.git
          cd kcov
          mkdir build && cd build
          cmake -G 'Ninja' ..
          ninja
          ninja install
          cp /usr/local/bin/kcov ~/.local/bin/
        }
        
        # Install shellcheck
        cd /tmp
        wget -qO- https://github.com/koalaman/shellcheck/releases/download/v0.10.0/shellcheck-v0.10.0.linux.x86_64.tar.xz | tar -xJ
        mv shellcheck-v0.10.0/shellcheck ~/.local/bin/
        chmod +x ~/.local/bin/shellcheck
        
        # Install shfmt
        wget -qO ~/.local/bin/shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64
        chmod +x ~/.local/bin/shfmt
        
        # Install shellspec
        curl -fsSL https://git.io/shellspec | sh -s -- --yes

    - name: Install tools (macOS)
      if: matrix.platform == 'macos' && steps.cache-tools-macos.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/.local/bin
        
        # Install tmux for configuration testing
        echo "Installing tmux via brew..."
        brew install tmux
        
        # Debug: Show where tmux was installed
        echo "Tmux installation paths:"
        which tmux || echo "tmux not found in PATH"
        ls -la /usr/local/bin/tmux 2>/dev/null || echo "/usr/local/bin/tmux not found"
        ls -la /opt/homebrew/bin/tmux 2>/dev/null || echo "/opt/homebrew/bin/tmux not found"
        echo "Brew prefix: $(brew --prefix)"
        echo "Brew --prefix tmux: $(brew --prefix tmux 2>/dev/null || echo 'not found')"
        
        # Install shellcheck
        wget -qO- https://github.com/koalaman/shellcheck/releases/download/v0.10.0/shellcheck-v0.10.0.darwin.x86_64.tar.xz | tar -xJ
        mv shellcheck-v0.10.0/shellcheck ~/.local/bin/
        chmod +x ~/.local/bin/shellcheck
        
        # Install shfmt
        wget -qO ~/.local/bin/shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_darwin_amd64
        chmod +x ~/.local/bin/shfmt
        
        # Install shellspec
        curl -fsSL https://git.io/shellspec | sh -s -- --yes
        
    - name: Debug cache status (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "Cache hit: ${{ steps.cache-tools-macos.outputs.cache-hit }}"
        echo "Checking cached tmux locations:"
        ls -la /usr/local/bin/tmux 2>/dev/null || echo "/usr/local/bin/tmux not found"
        ls -la /opt/homebrew/bin/tmux 2>/dev/null || echo "/opt/homebrew/bin/tmux not found"
        which tmux || echo "tmux not found in PATH"

    - name: Add tools to PATH
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        # Ensure brew-installed tools are in PATH on macOS
        if [ "${{ matrix.platform }}" = "macos" ]; then
          echo "/usr/local/bin" >> $GITHUB_PATH
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
        fi

    - name: Check formatting
      run: |
        echo "ðŸŽ¨ Checking bash script formatting on ${{ matrix.platform }}..."
        find . -type f \( -name "*.sh" -o -name "*.bash" \) \
          -not -path "./.git/*" \
          -not -path "./dotfiles/*/.*" \
          -exec shfmt -d {} \;
        
    - name: Lint scripts
      run: |
        echo "ðŸ” Linting bash scripts on ${{ matrix.platform }}..."
        find . -type f \( -name "*.sh" -o -name "*.bash" \) \
          -not -path "./.git/*" \
          -not -path "./dotfiles/*/.*" \
          -exec shellcheck {} \;
        shellcheck setup.sh setup-secrets
        
    - name: Run shellspec tests with coverage (Linux)
      if: matrix.platform == 'ubuntu' || matrix.platform == 'archlinux'
      shell: bash
      run: |
        echo "ðŸ§ª Running bash tests with coverage on ${{ matrix.platform }}..."
        # Run tests with kcov coverage
        shellspec --shell bash --kcov --covdir coverage \
          --kcov-options "--exclude-pattern=/.shellspec,/spec/,/dotfiles/,/.git/,/coverage/"
      
    - name: Run shellspec tests (macOS)
      if: matrix.platform == 'macos'
      shell: bash
      run: |
        echo "ðŸ§ª Running bash tests on ${{ matrix.platform }}..."
        shellspec --shell bash
      
    - name: Upload bash coverage (Linux)
      if: matrix.platform == 'ubuntu' || matrix.platform == 'archlinux'
      uses: actions/upload-artifact@v4
      with:
        name: bash-coverage-${{ matrix.platform }}
        path: coverage/

    - name: Generate bash coverage summary (Linux)
      if: matrix.platform == 'ubuntu' || matrix.platform == 'archlinux'
      run: |
        echo "ðŸ“Š Generating bash coverage summary..."
        if [ -f coverage/index.html ]; then
          # Extract coverage percentage from kcov HTML report
          COVERAGE=$(grep -o "covered.*%" coverage/index.html | head -1 | grep -o "[0-9]\+\.[0-9]\+")
          echo "Bash Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Bash Test Coverage (${{ matrix.platform }})**: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add coverage badge
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          echo "![Coverage](https://img.shields.io/badge/Bash_Coverage-${COVERAGE}%25-${COLOR})" >> $GITHUB_STEP_SUMMARY
        fi
      
    - name: Test dry-run functionality
      shell: bash
      run: |
        echo "ðŸš€ Testing dry-run functionality on ${{ matrix.platform }}..."
        # Test that dry-run works without requiring sudo/pacman
        export DOTFILES_DIR="./dotfiles/mrdavidlaing"
        ./setup.sh user --dry-run
        
        # Mock hostname command for server test to use 'baljeet' which has packages.yaml
        mkdir -p ~/.local/bin
        echo '#!/bin/bash' > ~/.local/bin/hostname
        echo 'echo "baljeet"' >> ~/.local/bin/hostname
        chmod +x ~/.local/bin/hostname
        export PATH="$HOME/.local/bin:$PATH"
        ./setup.sh server --dry-run
        echo "âœ… Dry-run tests passed on ${{ matrix.platform }}"

  test-powershell:
    name: PowerShell Tests
    strategy:
      matrix:
        os: [windows-latest]
        include:
          # Add specific PowerShell versions if needed
          - os: windows-latest
            powershell-version: "latest"
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PowerShell modules
      shell: pwsh
      run: |
        Write-Host "ðŸ”§ Setting up PowerShell environment on ${{ matrix.os }}..." -ForegroundColor Cyan
        
        # Install required modules
        $modules = @('Pester', 'PSScriptAnalyzer')
        foreach ($module in $modules) {
          if (-not (Get-Module -ListAvailable -Name $module)) {
            Write-Host "Installing $module..." -ForegroundColor Yellow
            Install-Module -Name $module -Force -SkipPublisherCheck -Scope CurrentUser
          } else {
            Write-Host "$module already installed" -ForegroundColor Green
          }
        }
        
        # Import modules
        Import-Module Pester -Force
        Import-Module PSScriptAnalyzer -Force

    - name: Run PowerShell linting
      shell: pwsh
      run: |
        Write-Host "ðŸ” Running PowerShell linting on ${{ matrix.os }}..." -ForegroundColor Cyan
        .\scripts\lint-powershell.ps1

    - name: Run Pester tests with coverage
      shell: pwsh
      run: |
        Write-Host "ðŸ§ª Running PowerShell tests with coverage on ${{ matrix.os }}..." -ForegroundColor Cyan
        
        # Configure Pester using the .pester.ps1 file
        $config = Import-PowerShellDataFile '.\.pester.ps1'
        $result = Invoke-Pester -Configuration $config
        
        # Generate coverage summary for GitHub
        if ($result.CodeCoverage) {
          $coverage = $result.CodeCoverage
          $coveragePercent = [math]::Round(($coverage.CoveragePercent), 2)
          
          Write-Host "ðŸ“Š PowerShell Coverage: $coveragePercent%" -ForegroundColor Cyan
          
          # Add to GitHub Step Summary
          "## ðŸ“Š PowerShell Test Results" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "**Coverage**: $coveragePercent%" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "**Tests Passed**: $($result.PassedCount)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "**Tests Failed**: $($result.FailedCount)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "**Tests Skipped**: $($result.SkippedCount)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "### Coverage Details" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "- **Lines Covered**: $($coverage.NumberOfCommandsExecuted) / $($coverage.NumberOfCommandsAnalyzed)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "- **Files Analyzed**: $($coverage.AnalyzedFiles.Count)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          "### Coverage Badge" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
          
          # Determine badge color based on coverage
          if ($coveragePercent -ge 80) { $color = "brightgreen" }
          elseif ($coveragePercent -ge 60) { $color = "yellow" }
          else { $color = "red" }
          
          "![Coverage](https://img.shields.io/badge/PowerShell_Coverage-$coveragePercent%25-$color)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
        }
        
        # Exit with error code if tests failed
        if ($result.FailedCount -gt 0) {
          Write-Host "âŒ $($result.FailedCount) tests failed" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "âœ… All $($result.PassedCount) PowerShell tests passed on ${{ matrix.os }}" -ForegroundColor Green

    - name: Test PowerShell dry-run functionality
      shell: pwsh
      run: |
        Write-Host "ðŸš€ Testing PowerShell dry-run functionality on ${{ matrix.os }}..." -ForegroundColor Cyan
        
        # Test that PowerShell dry-run works
        .\bin\setup-user.ps1 -DryRun
        
        # Mock hostname for server test to use 'baljeet' which has a packages.yaml
        $env:COMPUTERNAME = "baljeet"
        .\bin\setup-server.ps1 -DryRun
        Write-Host "âœ… PowerShell dry-run tests passed on ${{ matrix.os }}" -ForegroundColor Green

    - name: Upload PowerShell test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: powershell-test-results-${{ matrix.os }}
        path: |
          testresults.xml
          coverage.xml

    - name: Upload PowerShell coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: powershell-coverage-${{ matrix.os }}
        path: coverage.xml

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-bash, test-powershell]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Generate comprehensive test summary
      run: |
        echo "# ðŸ§ª Laingville Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Platform results
        echo "## ðŸŒ Platform Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Bash Tests | PowerShell Tests | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------------|------------------|---------|" >> $GITHUB_STEP_SUMMARY
        
        BASH_STATUS="${{ needs.test-bash.result }}"
        PS_STATUS="${{ needs.test-powershell.result }}"
        
        # Convert status to emoji
        if [ "$BASH_STATUS" = "success" ]; then BASH_EMOJI="âœ…"; else BASH_EMOJI="âŒ"; fi
        if [ "$PS_STATUS" = "success" ]; then PS_EMOJI="âœ…"; else PS_EMOJI="âŒ"; fi
        
        echo "| Ubuntu | $BASH_EMOJI | N/A | $BASH_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| Arch Linux | $BASH_EMOJI | N/A | $BASH_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | $BASH_EMOJI | N/A | $BASH_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | N/A | $PS_EMOJI | $PS_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        if [[ "$BASH_STATUS" == "success" && "$PS_STATUS" == "success" ]]; then
          echo "## ðŸŽ‰ Overall Result: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests passed across all platforms! ðŸš€" >> $GITHUB_STEP_SUMMARY
          
          # Add test counts if available
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Bash Tests (ShellSpec)**: ~194 examples" >> $GITHUB_STEP_SUMMARY
          echo "- **PowerShell Tests (Pester)**: ~98 tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Coverage**: Cross-platform validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms Tested**: Ubuntu, Arch Linux, macOS, Windows" >> $GITHUB_STEP_SUMMARY
          
        else
          echo "## âŒ Overall Result: FAILURE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some tests failed. Check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
        # Add coverage summary if artifacts exist
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ˆ Coverage Reports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Coverage reports have been uploaded as artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- Bash coverage (Linux only)" >> $GITHUB_STEP_SUMMARY
        echo "- PowerShell coverage (Windows)" >> $GITHUB_STEP_SUMMARY

    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: 'Test Results Summary'
        path: 'artifacts/powershell-test-results-*/testresults.xml'
        reporter: java-junit
        fail-on-error: 'false'

    - name: Code Coverage Summary
      uses: irongut/CodeCoverageSummary@v1.3.0
      if: always()
      with:
        filename: 'artifacts/powershell-coverage-*/coverage.xml'
        badge: true
        fail_below_min: false
        format: markdown
        hide_branch_rate: false
        hide_complexity: true
        indicators: true
        output: both
        thresholds: '60 80'

    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        recreate: true
        path: code-coverage-results.md