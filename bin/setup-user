#!/usr/bin/env bash

set -e

# Source functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
export SCRIPT_DIR
export PROJECT_ROOT
LIB_DIR="$PROJECT_ROOT/lib"
source "$LIB_DIR/polyfill.functions.bash"
source "$LIB_DIR/logging.functions.bash"
source "$LIB_DIR/security.functions.bash"
source "$LIB_DIR/shared.functions.bash"
source "$LIB_DIR/symlinks.functions.bash"
source "$LIB_DIR/setup-user.functions.bash"

# Simple argument parsing
DRY_RUN=false
if [ "$1" = "--dry-run" ]; then
    DRY_RUN=true
elif [ -n "$1" ]; then
    log_error "Unknown option: $1"
    log_error "Usage: $0 [--dry-run]"
    exit 1
fi

# Detect current user using common function
CURRENT_USER=$(detect_username)

# Initialize logging
log_init

# Map usernames to dotfiles folders (unless DOTFILES_DIR already set)
if [ -z "$DOTFILES_DIR" ]; then
    DOTFILES_DIR="$PROJECT_ROOT/dotfiles/$CURRENT_USER"
    log_info "Using dotfiles for user: $CURRENT_USER"
else
    # Validate externally set DOTFILES_DIR for security
    if ! validate_environment_variable "DOTFILES_DIR" "$DOTFILES_DIR" "$PROJECT_ROOT/dotfiles"; then
        log_error "Invalid DOTFILES_DIR environment variable: $DOTFILES_DIR"
        log_error "DOTFILES_DIR must be within $PROJECT_ROOT/dotfiles/"
        exit 1
    fi
fi

log_section "User Setup for $CURRENT_USER"
log_info "Using dotfiles from: $DOTFILES_DIR"

# Check if dotfiles directory exists
log_subsection "Validation"
if [ ! -d "$DOTFILES_DIR" ]; then
    log_error "Dotfiles directory $DOTFILES_DIR does not exist"
    exit 1
else
    log_success "Dotfiles directory found"
fi

# Handle shared dotfiles first
log_subsection "Shared Dotfiles"
SHARED_DOTFILES_DIR="$PROJECT_ROOT/dotfiles/shared"
if [ -d "$SHARED_DOTFILES_DIR" ] && [ "$(ls -A "$SHARED_DOTFILES_DIR" 2>/dev/null)" ]; then
    # Try symlinks.yaml first, fallback to recursive approach
    if ! setup_symlinks_from_yaml "$SHARED_DOTFILES_DIR" "$HOME" "$DRY_RUN"; then
        # Fallback to old recursive approach
        if [ "$DRY_RUN" = true ]; then
            show_symlinks "$SHARED_DOTFILES_DIR" "$HOME" ""
        else
            log_info "Setting up shared dotfiles..."
            create_symlinks "$SHARED_DOTFILES_DIR" "$HOME" ""
        fi
    fi
else
    log_info "No shared dotfiles found"
fi

# Handle user-specific dotfiles
log_subsection "User-Specific Dotfiles"
if [ "$(ls -A "$DOTFILES_DIR" 2>/dev/null)" ]; then
    # Try symlinks.yaml first, fallback to recursive approach
    if ! setup_symlinks_from_yaml "$DOTFILES_DIR" "$HOME" "$DRY_RUN"; then
        # Fallback to old recursive approach
        if [ "$DRY_RUN" = true ]; then
            show_symlinks "$DOTFILES_DIR" "$HOME" ""
        else
            log_info "Setting up user-specific dotfiles..."
            create_symlinks "$DOTFILES_DIR" "$HOME" ""
        fi
    fi
    
    if [ "$DRY_RUN" = false ]; then
        # Reload Hyprland config if hyprland.conf was linked and Hyprland is running
        if [ -f "$HOME/.config/hypr/hyprland.conf" ] && command -v hyprctl >/dev/null 2>&1; then
            if hyprctl version >/dev/null 2>&1; then
                log_info "Reloading Hyprland configuration..."
                hyprctl reload >/dev/null 2>&1 || log_warning "Could not reload Hyprland config"
            fi
        fi
        log_success "Dotfiles setup complete!"
    fi

    run_user_setup_hook "$DRY_RUN"
else
    if [ "$DRY_RUN" = true ]; then
        log_dry_run "No user dotfiles found - no symlinks would be created"
    else
        log_info "No user dotfiles found in $DOTFILES_DIR"
    fi
fi

# Handle package management
log_subsection "Package Management"
if [ -n "${PLATFORM:-}" ]; then
    PLATFORM="$PLATFORM"
else
    PLATFORM="$(detect_platform)"
fi

# macOS-specific setup (must happen before package installation)
if [ "$PLATFORM" = "macos" ]; then
    source "$LIB_DIR/macos.functions.bash"
    log_subsection "Homebrew Setup"
    install_homebrew "$DRY_RUN"
fi

# WSL-specific setup
if [ "$PLATFORM" = "wsl" ]; then
    source "$LIB_DIR/wsl.functions.bash"
fi

handle_packages "$PLATFORM" "$DRY_RUN"

# Setup systemd user services (like dynamic wallpaper timer)
log_subsection "System Services"
setup_systemd_services "$DRY_RUN"

# Configure sudo timeout to 12 hours
log_subsection "Sudo Configuration"
configure_sudo_timeout "$DRY_RUN"


# macOS-specific system configuration
if [ "$PLATFORM" = "macos" ]; then
    log_subsection "macOS System Configuration"
    configure_macos_system "$DRY_RUN"
fi

# Final completion handled by log_init trap

# Explicit exit for proper status
exit 0