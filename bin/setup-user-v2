#!/usr/bin/env bash

# setup-user-v2: User setup script using separated packages.yaml and symlinks.yaml
# This version uses declarative configuration instead of hardcoded platform exclusions

set -euo pipefail

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source required functions
source "$REPO_ROOT/lib/shared.functions.bash"
source "$REPO_ROOT/lib/logging.functions.bash"
source "$REPO_ROOT/lib/symlinks.functions.bash"
source "$REPO_ROOT/lib/security.functions.bash"
source "$REPO_ROOT/lib/polyfill.functions.bash"

# Default values
DRY_RUN=false
CURRENT_USER=$(whoami)
PLATFORM=$(detect_platform)

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --help)
      echo "Usage: $0 [--dry-run]"
      echo "  --dry-run  Show what would be done without making changes"
      exit 0
      ;;
    *)
      log_error "Unknown option: $1"
      echo "Usage: $0 [--dry-run]"
      exit 1
      ;;
  esac
done

# Determine user's dotfiles directory
get_user_dotfiles_dir() {
  local user="${1:-$CURRENT_USER}"
  case "$user" in
    timmy)
      echo "$REPO_ROOT/dotfiles/timmmmmmer"
      ;;
    david)
      echo "$REPO_ROOT/dotfiles/mrdavidlaing"
      ;;
    *)
      echo "$REPO_ROOT/dotfiles/mrdavidlaing"  # Default to mrdavidlaing
      ;;
  esac
}

# Setup symlinks from symlinks.yaml
setup_user_symlinks() {
  local dotfiles_dir="$1"
  local dry_run="$2"
  
  local symlinks_yml="$dotfiles_dir/symlinks.yaml"
  
  if [ ! -f "$symlinks_yml" ]; then
    log_warning "No symlinks.yaml found at $symlinks_yml"
    return 0
  fi
  
  log_section "Setting up symlinks for platform: $PLATFORM"
  
  # Process symlinks from symlinks.yaml
  process_platform_symlinks "$symlinks_yml" "$PLATFORM" "$dotfiles_dir" "$HOME" "$dry_run"
  
  # Also process shared symlinks if not using shared as primary
  if [[ "$dotfiles_dir" != *"/shared" ]]; then
    local shared_symlinks="$REPO_ROOT/dotfiles/shared/symlinks.yaml"
    if [ -f "$shared_symlinks" ]; then
      log_info "Processing shared symlinks..."
      process_platform_symlinks "$shared_symlinks" "$PLATFORM" "$REPO_ROOT/dotfiles/shared" "$HOME" "$dry_run"
    fi
  fi
}

# Install packages from packages.yaml
install_user_packages() {
  local dotfiles_dir="$1"
  local dry_run="$2"
  
  local packages_yml="$dotfiles_dir/packages.yaml"
  
  if [ ! -f "$packages_yml" ]; then
    log_warning "No packages.yaml found at $packages_yml"
    return 0
  fi
  
  log_section "Package Management"
  log_info "Platform: $PLATFORM"
  
  # Extract packages for current platform
  case "$PLATFORM" in
    arch|wsl)
      local packages
      packages=$(get_packages_from_file "$PLATFORM" "yay" "$packages_yml" 2>/dev/null)
      if [ -n "$packages" ]; then
        if [ "$dry_run" = "true" ]; then
          log_dry_run "Would install via yay:"
          echo "$packages" | tr ' ' '\n' | while read -r pkg; do
            [ -n "$pkg" ] && log_dry_run "  - $pkg"
          done
        else
          log_info "Installing packages via yay..."
          # Install packages (actual implementation needed)
        fi
      fi
      ;;
    macos)
      local brew_packages
      brew_packages=$(get_packages_from_file "$PLATFORM" "homebrew" "$packages_yml" 2>/dev/null)
      if [ -n "$brew_packages" ]; then
        if [ "$dry_run" = "true" ]; then
          log_dry_run "Would install via homebrew:"
          echo "$brew_packages" | tr ' ' '\n' | while read -r pkg; do
            [ -n "$pkg" ] && log_dry_run "  - $pkg"
          done
        else
          log_info "Installing packages via homebrew..."
          # Install packages (actual implementation needed)
        fi
      fi
      
      local cask_packages
      cask_packages=$(get_packages_from_file "$PLATFORM" "cask" "$packages_yml" 2>/dev/null)
      if [ -n "$cask_packages" ]; then
        if [ "$dry_run" = "true" ]; then
          log_dry_run "Would install via cask:"
          echo "$cask_packages" | tr ' ' '\n' | while read -r pkg; do
            [ -n "$pkg" ] && log_dry_run "  - $pkg"
          done
        else
          log_info "Installing packages via cask..."
          # Install packages (actual implementation needed)
        fi
      fi
      ;;
    windows)
      local winget_packages
      winget_packages=$(get_packages_from_file "$PLATFORM" "winget" "$packages_yml" 2>/dev/null)
      if [ -n "$winget_packages" ]; then
        if [ "$dry_run" = "true" ]; then
          log_dry_run "Would install via winget:"
          echo "$winget_packages" | tr ' ' '\n' | while read -r pkg; do
            [ -n "$pkg" ] && log_dry_run "  - $pkg"
          done
        else
          log_info "Installing packages via winget..."
          # Install packages (actual implementation needed)
        fi
      fi
      ;;
    *)
      log_warning "Unknown platform: $PLATFORM"
      ;;
  esac
}

# Process custom scripts
process_custom_scripts() {
  local dotfiles_dir="$1"
  local dry_run="$2"
  
  local packages_yml="$dotfiles_dir/packages.yaml"
  
  if [ ! -f "$packages_yml" ]; then
    return 0
  fi
  
  # Extract custom scripts for platform
  local scripts
  scripts=$(get_custom_scripts_from_yaml "$packages_yml" "$PLATFORM")
  
  if [ -z "$scripts" ]; then
    return 0
  fi
  
  log_section "Custom Scripts"
  
  while IFS= read -r script; do
    [ -z "$script" ] && continue
    
    # Validate script name
    if ! validate_script_name "$script"; then
      log_error "Invalid script name: $script"
      continue
    fi
    
    local script_path="$REPO_ROOT/dotfiles/shared/scripts/$script.bash"
    
    if [ "$dry_run" = "true" ]; then
      log_dry_run "Would run custom script: $script"
    else
      if [ -f "$script_path" ] && [ -x "$script_path" ]; then
        log_info "Running custom script: $script"
        if "$script_path"; then
          log_success "Script completed: $script"
        else
          log_error "Script failed: $script"
        fi
      else
        log_warning "Script not found or not executable: $script_path"
      fi
    fi
  done <<< "$scripts"
}

# Extract custom scripts from packages.yaml
get_custom_scripts_from_yaml() {
  local yaml_file="$1"
  local platform="$2"
  
  [ ! -f "$yaml_file" ] && return 1
  
  # Extract custom scripts section
  local in_platform=0
  local in_custom=0
  
  while IFS= read -r line; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
    
    # Check if we're entering the platform section
    if [[ "$line" =~ ^${platform}: ]]; then
      in_platform=1
      continue
    fi
    
    # If we're in the platform section
    if [ $in_platform -eq 1 ]; then
      # If we hit a top-level key, we're done
      if [[ "$line" =~ ^[^[:space:]] ]]; then
        break
      fi
      
      # Check for packages.custom section
      if [[ "$line" =~ ^[[:space:]]+custom: ]]; then
        in_custom=1
        continue
      fi
      
      # Process custom script entries
      if [ $in_custom -eq 1 ]; then
        if [[ "$line" =~ ^[[:space:]]+-[[:space:]](.+) ]]; then
          echo "${BASH_REMATCH[1]}"
        elif [[ ! "$line" =~ ^[[:space:]]+-[[:space:]] ]]; then
          # End of custom section
          in_custom=0
        fi
      fi
    fi
  done < "$yaml_file"
}

# Main setup process
main() {
  log_section "Starting setup-user"
  
  if [ "$DRY_RUN" = "true" ]; then
    log_info "DRY RUN MODE - No changes will be made"
  fi
  
  log_info "User: $CURRENT_USER"
  log_info "Platform: $PLATFORM"
  
  # Get user's dotfiles directory
  USER_DOTFILES_DIR=$(get_user_dotfiles_dir "$CURRENT_USER")
  log_info "Using dotfiles from: $USER_DOTFILES_DIR"
  
  # Validate dotfiles directory exists
  if [ ! -d "$USER_DOTFILES_DIR" ]; then
    log_error "Dotfiles directory not found: $USER_DOTFILES_DIR"
    exit 1
  fi
  
  # Setup symlinks from symlinks.yaml
  setup_user_symlinks "$USER_DOTFILES_DIR" "$DRY_RUN"
  
  # Install packages from packages.yaml
  install_user_packages "$USER_DOTFILES_DIR" "$DRY_RUN"
  
  # Process custom scripts
  process_custom_scripts "$USER_DOTFILES_DIR" "$DRY_RUN"
  
  # Run user-specific setup hook if exists
  local setup_hook="$USER_DOTFILES_DIR/setup-user-hook.sh"
  if [ -f "$setup_hook" ] && [ -x "$setup_hook" ]; then
    log_section "User Setup Hook"
    if [ "$DRY_RUN" = "true" ]; then
      log_dry_run "Would run user setup hook"
    else
      log_info "Running user setup hook..."
      if "$setup_hook"; then
        log_success "User setup hook completed"
      else
        log_error "User setup hook failed"
      fi
    fi
  fi
  
  log_success "Setup complete!"
}

# Run main
main "$@"