#!/usr/bin/env bash
set -euo pipefail

# bash 3.2 compatible lowercase conversion
_tolower() {
    echo "$1" | tr '[:upper:]' '[:lower:]'
}

severity_to_priority() {
    local severity
    severity=$(_tolower "$1")
    local has_exploit="${2:-false}"
    
    case "$severity" in
        critical)
            if [[ "$has_exploit" == "true" ]]; then
                echo "1"
            else
                echo "2"
            fi
            ;;
        high)
            if [[ "$has_exploit" == "true" ]]; then
                echo "3"
            else
                echo "4"
            fi
            ;;
        *)
            echo "5"
            ;;
    esac
}

extract_cve_id() {
    local rule_id="$1"
    local cve_pattern='CVE-[0-9]{4}-[0-9]+'
    
    if [[ "$rule_id" =~ $cve_pattern ]]; then
        echo "${BASH_REMATCH[0]}"
    else
        echo ""
    fi
}

extract_image_name() {
    local rule_id="$1"
    local scanner_pattern='^(trivy|grype)-(.+)-CVE-[0-9]{4}-[0-9]+$'
    
    if [[ "$rule_id" =~ $scanner_pattern ]]; then
        echo "${BASH_REMATCH[2]}"
    else
        echo ""
    fi
}

get_higher_severity() {
    local sev1
    sev1=$(_tolower "$1")
    local sev2
    sev2=$(_tolower "$2")
    
    # Bash 3.2 compatible: use case instead of associative array
    local rank1=5
    case "$sev1" in
        critical) rank1=1 ;;
        high) rank1=2 ;;
        medium) rank1=3 ;;
        low) rank1=4 ;;
    esac
    
    local rank2=5
    case "$sev2" in
        critical) rank2=1 ;;
        high) rank2=2 ;;
        medium) rank2=3 ;;
        low) rank2=4 ;;
    esac
    
    if [[ "$rank1" -le "$rank2" ]]; then
        echo "$sev1"
    else
        echo "$sev2"
    fi
}

triage_alerts() {
    local alerts_json="$1"
    
    if [[ "$alerts_json" == "[]" ]] || [[ -z "$alerts_json" ]]; then
        echo "[]"
        return
    fi
    
    # Bash 3.2 compatible: use delimited strings instead of associative arrays
    local cve_severity=""
    local cve_description=""
    local cve_images=""
    local cve_rule_ids=""
    
    local alert_count
    alert_count=$(echo "$alerts_json" | jq 'length')
    
    for ((i=0; i<alert_count; i++)); do
        local alert
        alert=$(echo "$alerts_json" | jq ".[$i]")
        
        local state
        state=$(echo "$alert" | jq -r '.state')
        if [[ "$state" != "open" ]]; then
            continue
        fi
        
        local rule_id severity description
        rule_id=$(echo "$alert" | jq -r '.rule.id')
        severity=$(echo "$alert" | jq -r '.rule.severity')
        description=$(echo "$alert" | jq -r '.rule.description')
        
        local cve_id
        cve_id=$(extract_cve_id "$rule_id")
        
        if [[ -z "$cve_id" ]]; then
            continue
        fi
        
        # Update severity (use higher severity if exists)
        local existing_severity
        existing_severity=$(echo "$cve_severity" | grep "^${cve_id}|" | cut -d'|' -f2)
        if [[ -n "$existing_severity" ]]; then
            local new_severity
            new_severity=$(get_higher_severity "$existing_severity" "$severity")
            cve_severity=$(echo "$cve_severity" | grep -v "^${cve_id}|")
            cve_severity="${cve_severity}"$'\n'"${cve_id}|${new_severity}"
        else
            cve_severity="${cve_severity}"$'\n'"${cve_id}|${severity}"
            cve_description="${cve_description}"$'\n'"${cve_id}|${description}"
        fi
        
        # Update images list
        local image_name
        image_name=$(extract_image_name "$rule_id")
        if [[ -n "$image_name" ]]; then
            local existing_images
            existing_images=$(echo "$cve_images" | grep "^${cve_id}|" | cut -d'|' -f2)
            if [[ -n "$existing_images" ]]; then
                if [[ ! "$existing_images" =~ (^|,)"$image_name"(,|$) ]]; then
                    cve_images=$(echo "$cve_images" | grep -v "^${cve_id}|")
                    cve_images="${cve_images}"$'\n'"${cve_id}|${existing_images},${image_name}"
                fi
            else
                cve_images="${cve_images}"$'\n'"${cve_id}|${image_name}"
            fi
        fi
        
        # Update rule IDs list
        local existing_rules
        existing_rules=$(echo "$cve_rule_ids" | grep "^${cve_id}|" | cut -d'|' -f2)
        if [[ -n "$existing_rules" ]]; then
            cve_rule_ids=$(echo "$cve_rule_ids" | grep -v "^${cve_id}|")
            cve_rule_ids="${cve_rule_ids}"$'\n'"${cve_id}|${existing_rules},${rule_id}"
        else
            cve_rule_ids="${cve_rule_ids}"$'\n'"${cve_id}|${rule_id}"
        fi
    done
    
    local results=()
    while IFS='|' read -r cve_id severity; do
        if [[ -z "$cve_id" ]]; then
            continue
        fi
        
        local priority
        priority=$(severity_to_priority "$severity" "false")
        
        local images_list
        images_list=$(echo "$cve_images" | grep "^${cve_id}|" | cut -d'|' -f2)
        local images_json
        if [[ -n "$images_list" ]]; then
            images_json=$(echo "$images_list" | tr ',' '\n' | jq -R . | jq -s .)
        else
            images_json="[]"
        fi
        
        local rule_ids_list
        rule_ids_list=$(echo "$cve_rule_ids" | grep "^${cve_id}|" | cut -d'|' -f2)
        local rule_ids_json
        rule_ids_json=$(echo "$rule_ids_list" | tr ',' '\n' | jq -R . | jq -s .)
        
        local desc
        desc=$(echo "$cve_description" | grep "^${cve_id}|" | cut -d'|' -f2-)
        
        local entry
        local severity_lower
        severity_lower=$(_tolower "$severity")
        entry=$(jq -n \
            --arg cve_id "$cve_id" \
            --argjson priority "$priority" \
            --arg severity "$severity_lower" \
            --argjson affected_images "$images_json" \
            --argjson rule_ids "$rule_ids_json" \
            --arg description "$desc" \
            '{
                cve_id: $cve_id,
                priority: $priority,
                severity: $severity,
                affected_images: $affected_images,
                rule_ids: $rule_ids,
                description: $description
            }')
        results+=("$entry")
    done <<< "$cve_severity"
    
    if [[ ${#results[@]} -eq 0 ]]; then
        echo "[]"
        return
    fi
    
    printf '%s\n' "${results[@]}" | jq -s 'sort_by(.priority)'
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    if [[ -t 0 ]]; then
        echo "Usage: gh api /repos/{owner}/{repo}/code-scanning/alerts | $0" >&2
        exit 1
    fi
    
    input=$(cat)
    triage_alerts "$input"
fi
